# LIQUI MOLY Taiwan AI 聊天機器人 - 功能架構圖

## 1. 系統總覽架構圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              使用者介面層                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐       │
│  │   網頁前端        │    │  Facebook        │    │  Instagram       │       │
│  │   (index.html)   │    │  Messenger       │    │  DM              │       │
│  │                  │    │                  │    │                  │       │
│  │  js/chat.js      │    │                  │    │                  │       │
│  │  css/style.css   │    │                  │    │                  │       │
│  └────────┬─────────┘    └────────┬─────────┘    └────────┬─────────┘       │
│           │                       │                       │                 │
│           └───────────────────────┼───────────────────────┘                 │
│                                   ▼                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API 層 (Vercel Serverless)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                         api/chat.js                                   │   │
│  │                      (主要聊天入口)                                    │   │
│  │   • 接收用戶訊息                                                       │   │
│  │   • 調用 RAG 管線                                                      │   │
│  │   • 呼叫 Gemini API                                                   │   │
│  │   • 驗證 AI 回覆                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │ api/analyze.js  │  │ api/search.js   │  │ api/meta-webhook.js         │  │
│  │ (AI 問題分析)    │  │ (產品搜尋)      │  │ (Meta Webhook 處理)          │  │
│  │                 │  │                 │  │                             │  │
│  │ • Gemini 分析   │  │ • 產品過濾      │  │ • FB/IG 訊息接收             │  │
│  │ • 車型偵測      │  │ • 認證匹配      │  │ • 真人客服切換               │  │
│  │ • 認證需求      │  │ • 排序推薦      │  │ • 訊息分段發送               │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          核心業務邏輯層 (lib/)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                       rag-pipeline.js                                 │   │
│  │                    (RAG 處理管線入口)                                  │   │
│  │                                                                       │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │   │
│  │  │ Step 1  │→ │ Step 2  │→ │ Step 3  │→ │ Step 4  │→ │ Step 5  │    │   │
│  │  │ AI分析  │  │ 規則備援 │  │ 知識檢索 │  │ 產品搜尋 │  │ Prompt  │    │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │ intent-classifier  │  │ knowledge-retriever│  │ prompt-builder     │     │
│  │ intent-converter   │  │ knowledge-cache    │  │ agent-prompts      │     │
│  │ (意圖分類)          │  │ (知識檢索)          │  │ (提示詞建構)        │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
│                                                                              │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │ vehicle-matcher    │  │ certification-     │  │ motorcycle-rules   │     │
│  │ (車型匹配)          │  │ matcher            │  │ (摩托車規則)        │     │
│  │                    │  │ (認證匹配)          │  │                    │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
│                                                                              │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │ response-validator │  │ search-helper      │  │ constants          │     │
│  │ (防幻覺驗證)        │  │ (搜尋輔助)          │  │ logger             │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         知識庫層 (data/knowledge/)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ core-identity   │  │ vehicle-specs   │  │ additive-guide  │             │
│  │ .json           │  │ .json           │  │ .json           │             │
│  │ 品牌身份+規範    │  │ 車型規格資料庫   │  │ 添加劑症狀對照   │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ ai-analysis-    │  │ search-reference│  │ anti-hallucin-  │             │
│  │ rules.json      │  │ .json           │  │ ation-rules.json│             │
│  │ AI分析規則      │  │ 搜尋關鍵字      │  │ 防幻覺規則      │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             外部服務層                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │  Google Gemini  │  │   Meta Graph    │  │    Wix CMS      │             │
│  │      API        │  │      API        │  │      API        │             │
│  │                 │  │                 │  │                 │             │
│  │ • AI 回覆生成   │  │ • 訊息發送/接收  │  │ • 產品資料庫    │             │
│  │ • 問題分析      │  │ • 用戶資料      │  │ • 對話記錄      │             │
│  │ • 多語言翻譯    │  │ • Quick Reply   │  │ • 暫停狀態管理  │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 資料流向圖

```
┌────────────────────────────────────────────────────────────────────────────┐
│                           用戶訊息處理流程                                  │
└────────────────────────────────────────────────────────────────────────────┘

  用戶輸入: "我的 Toyota Camry 2020 適合什麼機油？"
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 1: AI 意圖分析                                                │
  │  ┌─────────────────────────────────────────────────────────────┐   │
  │  │  api/analyze.js → Gemini API                                │   │
  │  │                                                              │   │
  │  │  輸入: 用戶訊息                                               │   │
  │  │  輸出: {                                                     │   │
  │  │    vehicles: [{ brand: "Toyota", model: "Camry", year: 2020,│   │
  │  │                 viscosity: "5W-30", certs: ["API SP"] }]    │   │
  │  │  }                                                           │   │
  │  └─────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 2: 意圖分類 (Fallback: 規則型)                                │
  │  ┌─────────────────────────────────────────────────────────────┐   │
  │  │  intent-classifier.js / intent-converter.js                 │   │
  │  │                                                              │   │
  │  │  輸出: {                                                     │   │
  │  │    type: "product_recommendation",                          │   │
  │  │    vehicleType: "汽車",                                      │   │
  │  │    vehicleBrand: "Toyota",                                  │   │
  │  │    vehicleModel: "Camry",                                   │   │
  │  │    productCategory: "機油",                                  │   │
  │  │    certifications: ["API SP", "ILSAC GF-6A"]               │   │
  │  │  }                                                           │   │
  │  └─────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 3: 知識檢索                                                   │
  │  ┌─────────────────────────────────────────────────────────────┐   │
  │  │  knowledge-retriever.js + knowledge-cache.js                │   │
  │  │                                                              │   │
  │  │  載入:                                                       │   │
  │  │  • core-identity.json (品牌規範)                             │   │
  │  │  • vehicle-specs.json (Toyota Camry 規格)                   │   │
  │  │  • search-reference.json (API SP 認證說明)                  │   │
  │  └─────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 4: 產品搜尋                                                   │
  │  ┌─────────────────────────────────────────────────────────────┐   │
  │  │  api/search.js                                               │   │
  │  │                                                              │   │
  │  │  過濾條件:                                                    │   │
  │  │  • 黏度: 5W-30                                               │   │
  │  │  • 認證: API SP, ILSAC GF-6A                                │   │
  │  │  • 車型: 汽車                                                 │   │
  │  │                                                              │   │
  │  │  輸出: [                                                     │   │
  │  │    { name: "Molygen 5W-30", sku: "LM2571", score: 95 },    │   │
  │  │    { name: "Top Tec 4200", sku: "LM8973", score: 90 },     │   │
  │  │    { name: "Special Tec", sku: "LM2700", score: 85 }       │   │
  │  │  ]                                                           │   │
  │  └─────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 5: Prompt 建構                                                │
  │  ┌─────────────────────────────────────────────────────────────┐   │
  │  │  prompt-builder.js + agent-prompts.js                       │   │
  │  │                                                              │   │
  │  │  組合:                                                       │   │
  │  │  • System Instruction (品牌規範)                             │   │
  │  │  • 產品資料庫 (符合條件的產品)                                │   │
  │  │  • 車型資訊 (Toyota Camry 2020 規格)                        │   │
  │  │  • 回覆範本 (product_recommendation)                        │   │
  │  └─────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 6: Gemini AI 生成回覆                                         │
  │  ┌─────────────────────────────────────────────────────────────┐   │
  │  │  api/chat.js → Gemini 2.0 Flash                             │   │
  │  │                                                              │   │
  │  │  輸入:                                                       │   │
  │  │  • System Prompt (800-1200 tokens)                          │   │
  │  │  • 對話歷史                                                  │   │
  │  │  • 用戶訊息                                                  │   │
  │  │                                                              │   │
  │  │  輸出: AI 生成的產品推薦回覆                                  │   │
  │  └─────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 7: 防幻覺驗證                                                 │
  │  ┌─────────────────────────────────────────────────────────────┐   │
  │  │  response-validator.js                                       │   │
  │  │                                                              │   │
  │  │  檢查:                                                       │   │
  │  │  • 提取所有 SKU (LM2571, LM8973, LM2700)                    │   │
  │  │  • 驗證每個 SKU 存在於產品資料庫                             │   │
  │  │  • 移除無效 SKU 並加上警告                                   │   │
  │  │                                                              │   │
  │  │  結果: ✓ 所有 SKU 有效                                       │   │
  │  └─────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────┘
       │
       ▼
  最終回覆發送給用戶
```

---

## 3. 模組依賴關係圖

```
                           ┌─────────────────┐
                           │   api/chat.js   │
                           │   (主入口)       │
                           └────────┬────────┘
                                    │
               ┌────────────────────┼────────────────────┐
               │                    │                    │
               ▼                    ▼                    ▼
    ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
    │ rag-pipeline.js │  │ api/analyze.js  │  │ response-       │
    │ (RAG 管線)       │  │ (AI 分析)       │  │ validator.js    │
    └────────┬────────┘  └────────┬────────┘  │ (防幻覺驗證)     │
             │                    │           └─────────────────┘
    ┌────────┼────────────────────┤
    │        │                    │
    ▼        ▼                    ▼
┌───────┐ ┌───────┐        ┌────────────┐
│intent-│ │knowl- │        │vehicle-    │
│classi-│ │edge-  │        │matcher.js  │
│fier.js│ │retriev│        └─────┬──────┘
└───┬───┘ │er.js  │              │
    │     └───┬───┘        ┌─────┴──────┐
    ▼         │            │            │
┌───────┐     │            ▼            ▼
│intent-│     │     ┌───────────┐ ┌───────────┐
│conver-│     │     │certifica- │ │motorcycle-│
│ter.js │     │     │tion-match-│ │rules.js   │
└───────┘     │     │er.js      │ └───────────┘
              ▼     └───────────┘
       ┌───────────┐
       │knowledge- │
       │cache.js   │
       └─────┬─────┘
             │
             ▼
    ┌─────────────────────────┐
    │   data/knowledge/*.json │
    │                         │
    │  • core-identity.json   │
    │  • vehicle-specs.json   │
    │  • ai-analysis-rules    │
    │  • search-reference     │
    │  • additive-guide       │
    └─────────────────────────┘
```

---

## 4. Meta Webhook 處理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     api/meta-webhook.js 處理流程                         │
└─────────────────────────────────────────────────────────────────────────┘

  Meta 伺服器 POST 請求
       │
       ▼
  ┌─────────────────┐
  │ 訊息去重檢查     │ ←── 快取 60 秒
  │ (message.mid)   │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────────────────────────────────────────────┐
  │                    訊息類型判斷                          │
  └────────────────────────┬────────────────────────────────┘
                           │
       ┌───────────────────┼───────────────────┐
       │                   │                   │
       ▼                   ▼                   ▼
  ┌─────────┐        ┌─────────┐        ┌─────────┐
  │ 附件    │        │ Echo    │        │ 純文字  │
  │ (圖片)  │        │ (管理員)│        │         │
  └────┬────┘        └────┬────┘        └────┬────┘
       │                  │                  │
       ▼                  ▼                  ▼
  暫停 AI 30分鐘    重置暫停時間        檢查暫停狀態
  轉接真人客服      記錄管理員回覆           │
                                            │
                          ┌─────────────────┴─────────────────┐
                          │                                   │
                          ▼                                   ▼
                     用戶已暫停                           用戶未暫停
                     靜默記錄                                 │
                                                             ▼
                                                    ┌─────────────────┐
                                                    │ 取得對話歷史     │
                                                    │ (Wix API)       │
                                                    └────────┬────────┘
                                                             │
                                                             ▼
                                                    ┌─────────────────┐
                                                    │ 呼叫 /api/chat  │
                                                    │ 取得 AI 回覆    │
                                                    └────────┬────────┘
                                                             │
                                                             ▼
                                                    ┌─────────────────┐
                                                    │ 格式化回覆      │
                                                    │ • MD → 純文字   │
                                                    │ • 長訊息分段    │
                                                    │ • 加 🤖 前綴    │
                                                    └────────┬────────┘
                                                             │
                                                             ▼
                                                    ┌─────────────────┐
                                                    │ 發送至 Meta     │
                                                    │ Graph API      │
                                                    └────────┬────────┘
                                                             │
                                                             ▼
                                                    ┌─────────────────┐
                                                    │ 非同步儲存對話   │
                                                    │ (Wix CMS)      │
                                                    └─────────────────┘
```

---

## 5. 防幻覺三層防線

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        防幻覺機制 (Anti-Hallucination)                   │
└─────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────┐
  │  第一層: System Instruction                                          │
  │  ┌──────────────────────────────────────────────────────────────┐  │
  │  │  core-identity.json                                          │  │
  │  │                                                               │  │
  │  │  規則:                                                        │  │
  │  │  • 禁止編造不存在的產品                                        │  │
  │  │  • 只能推薦產品資料庫中的項目                                  │  │
  │  │  • 必須使用真實 SKU (LM####)                                 │  │
  │  │  • 不確定時承認不知道                                         │  │
  │  └──────────────────────────────────────────────────────────────┘  │
  └─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  第二層: 知識庫覆蓋                                                  │
  │  ┌──────────────────────────────────────────────────────────────┐  │
  │  │  prompt-builder.js                                           │  │
  │  │                                                               │  │
  │  │  策略:                                                        │  │
  │  │  • 將符合條件的產品嵌入 Prompt                                 │  │
  │  │  • AI 只能從提供的產品中選擇                                   │  │
  │  │  • 減少 AI 需要「記憶」產品資訊的機會                          │  │
  │  └──────────────────────────────────────────────────────────────┘  │
  └─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  第三層: 回覆驗證                                                    │
  │  ┌──────────────────────────────────────────────────────────────┐  │
  │  │  response-validator.js                                       │  │
  │  │                                                               │  │
  │  │  檢查:                                                        │  │
  │  │  • 提取 AI 回覆中的所有 SKU                                   │  │
  │  │  • 驗證每個 SKU 存在於產品資料庫                               │  │
  │  │  • 過濾可能是年份的誤判 (2019-2030)                           │  │
  │  │  • 黑名單 SKU 檢查                                            │  │
  │  │  • 移除無效 SKU 並加上警告訊息                                │  │
  │  └──────────────────────────────────────────────────────────────┘  │
  └─────────────────────────────────────────────────────────────────────┘
```

---

## 6. 檔案清單與行數統計

| 檔案 | 行數 | 職責 |
|------|------|------|
| **API 層** | | |
| api/chat.js | ~200 | 主聊天入口 |
| api/analyze.js | ~1332 | AI 問題分析 (⚠️ 超標) |
| api/search.js | ~1170 | 產品搜尋 (⚠️ 超標) |
| api/meta-webhook.js | ~1031 | Meta Webhook (⚠️ 超標) |
| **核心邏輯層** | | |
| lib/rag-pipeline.js | ~300 | RAG 管線 |
| lib/prompt-builder.js | ~998 | Prompt 建構 (⚠️ 接近上限) |
| lib/certification-matcher.js | ~500 | 認證匹配 |
| lib/motorcycle-rules.js | ~400 | 摩托車規則 |
| lib/vehicle-matcher.js | ~350 | 車型匹配 |
| lib/response-validator.js | ~200 | 防幻覺驗證 |
| lib/knowledge-cache.js | ~150 | 知識快取 |
| lib/intent-classifier.js | ~250 | 意圖分類 |
| **知識庫** | | |
| data/knowledge/*.json | ~10 files | JSON 知識檔案 |

---

## 7. 外部 API 整合摘要

| 服務 | 用途 | 模組 |
|------|------|------|
| **Google Gemini 2.0 Flash** | AI 回覆生成、問題分析 | api/chat.js, api/analyze.js |
| **Meta Graph API** | FB/IG 訊息收發 | api/meta-webhook.js |
| **Wix CMS API** | 產品資料庫、對話記錄 | api/search.js, api/meta-webhook.js |

---

*報告產生日期: 2026-01-27*
